<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>{{ pair }} Detayları</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #ffffff;
        }
        .detail-container {
            width: 80%;
            margin: 20px auto;
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .detail-item {
            margin: 10px 0;
        }
        .detail-item label {
            font-weight: 600;
            color: #ffffff;
        }
        canvas {
            margin-top: 20px;
            max-width: 100%;
        }
        .fibonacci-levels {
            margin-top: 20px;
        }
        .fibonacci-levels h3 {
            color: #ffffff;
        }
        .fibonacci-levels ul {
            list-style: none;
            padding: 0;
        }
        .fibonacci-levels li {
            margin: 5px 0;
        }
        .highlight {
            color: #ffaa00;
            font-weight: bold;
        }
        .timeframe-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        select {
            padding: 5px;
            background-color: #3c3c3c;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #1e90ff;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-family: 'Roboto', sans-serif;
            margin: 10px 0;
        }
        .back-button:hover {
            background-color: #156bbf;
        }
        .indicator-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
            background-color: #3c3c3c;
            border-radius: 8px;
        }
        .indicator-table th, .indicator-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        .indicator-table th {
            background-color: #4c4c4c;
            color: #ffffff;
        }
        .indicator-table .signal {
            font-weight: bold;
        }
        .indicator-table .signal.alim {
            color: #28a745;
        }
        .indicator-table .signal.satis {
            color: #dc3545;
        }
        .indicator-table .signal.notr {
            color: #6c757d;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <h1>{{ pair }} Detayları</h1>
    <div style="text-align: center;">
        <a href="{% url 'trading_pairs' %}" class="back-button">Trading Pairs</a>
    </div>
    <div class="detail-container">
        <div class="timeframe-selector">
            <label for="timeframe">Zaman Dilimi: </label>
            <select id="timeframe" onchange="updateTimeframe()">
                <option value="hour" {% if timeframe == 'hour' %}selected{% endif %}>1 Saatlik</option>
                <option value="4hour" {% if timeframe == '4hour' %}selected{% endif %}>4 Saatlik</option>
                <option value="day" {% if timeframe == 'day' %}selected{% endif %}>Günlük</option>
                <option value="week" {% if timeframe == 'week' %}selected{% endif %}>Haftalık</option>
            </select>
        </div>
        <table class="indicator-table">
            <thead>
                <tr>
                    <th>Gösterge</th>
                    <th>Değer</th>
                    <th>Sinyal</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Güncel Fiyat</td>
                    <td>{{ current_price }}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>50 Günlük SMA</td>
                    <td>{{ sma_50 }}</td>
                    <td>
                        {% if sma_50 > sma_200 %}
                            <span class="signal alim">Alım</span>
                        {% elif sma_50 < sma_200 %}
                            <span class="signal satis">Satış</span>
                        {% else %}
                            <span class="signal notr">Nötr</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>200 Günlük SMA</td>
                    <td>{{ sma_200 }}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Stochastic %K</td>
                    <td>{{ stoch_k }}</td>
                    <td>
                        {% if stoch_k > stoch_d %}
                            <span class="signal alim">Alım</span>
                        {% elif stoch_k < stoch_d %}
                            <span class="signal satis">Satış</span>
                        {% else %}
                            <span class="signal notr">Nötr</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Stochastic %D</td>
                    <td>{{ stoch_d }}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>ADX</td>
                    <td>{{ adx }}</td>
                    <td>
                        {% if adx > 25 %}
                            <span class="signal alim">Güçlü Trend</span>
                        {% else %}
                            <span class="signal notr">Zayıf Trend</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>RSI</td>
                    <td>{{ rsi }}</td>
                    <td>
                        {% if rsi < 30 %}
                            <span class="signal alim">Aşırı Satım (Alım)</span>
                        {% elif rsi > 70 %}
                            <span class="signal satis">Aşırı Alım (Satış)</span>
                        {% else %}
                            <span class="signal notr">Nötr</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Son 7 Gün Fiyat Değişimi (%)</td>
                    <td>{{ price_change_7d }}</td>
                    <td>
                        {% if price_change_7d > 0 %}
                            <span class="signal alim">Yükseliş</span>
                        {% elif price_change_7d < 0 %}
                            <span class="signal satis">Düşüş</span>
                        {% else %}
                            <span class="signal notr">Değişimsiz</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>ATR</td>
                    <td>{{ atr }}</td>
                    <td>
                        {% if atr > 1 %}
                            <span class="signal satis">Yüksek Volatilite</span>
                        {% else %}
                            <span class="signal notr">Normal Volatilite</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>VWAP</td>
                    <td>{{ vwap }}</td>
                    <td>
                        {% if current_price > vwap %}
                            <span class="signal alim">Fiyat Üzerinde</span>
                        {% elif current_price < vwap %}
                            <span class="signal satis">Fiyat Altında</span>
                        {% else %}
                            <span class="signal notr">Eşit</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <strong>Ichimoku Bulutu</strong>
                        {% if ichimoku != 'Veri Yok' %}
                        <table class="indicator-table">
                            <thead>
                                <tr>
                                    <th>Bileşen</th>
                                    <th>Değer</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tenkan-sen</td>
                                    <td>{{ ichimoku.tenkan_sen }}</td>
                                    <td>
                                        {% if current_price > ichimoku.tenkan_sen %}
                                            <span class="signal alim">Fiyat Üzerinde</span>
                                        {% elif current_price < ichimoku.tenkan_sen %}
                                            <span class="signal satis">Fiyat Altında</span>
                                        {% else %}
                                            <span class="signal notr">Eşit</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Kijun-sen</td>
                                    <td>{{ ichimoku.kijun_sen }}</td>
                                    <td>
                                        {% if current_price > ichimoku.kijun_sen %}
                                            <span class="signal alim">Fiyat Üzerinde</span>
                                        {% elif current_price < ichimoku.kijun_sen %}
                                            <span class="signal satis">Fiyat Altında</span>
                                        {% else %}
                                            <span class="signal notr">Eşit</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Senkou Span A</td>
                                    <td>{{ ichimoku.senkou_span_a }}</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>Senkou Span B</td>
                                    <td>{{ ichimoku.senkou_span_b }}</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>Chikou Span</td>
                                    <td>{{ ichimoku.chikou_span }}</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                        {% else %}
                            <p>Ichimoku verileri şu anda mevcut değil.</p>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="fibonacci-levels">
            <h3>Fibonacci Seviyeleri ve Analiz</h3>
            <ul>
                {% for level, data in fibonacci_levels.items %}
                <li {% if level == closest_level %}class="highlight"{% endif %}>
                    {{ level }}: {{ data.value }} 
                    (Reversal: %{{ data.turn_probability }}, 
                    Uptrend: %{{ data.rise_probability }}, 
                    Downtrend: %{{ data.fall_probability }})
                </li>
                {% endfor %}
            </ul>
        </div>
        <canvas id="priceChart" height="200"></canvas>
    </div>
    <script>
        console.log("Historical Prices:", {{ historical_prices|safe }});
        console.log("Fibonacci Levels:", {{ fibonacci_levels|safe }});
        console.log("Current Price:", {{ current_price|safe }});

        const ctx = document.getElementById('priceChart').getContext('2d');
        const prices = {{ historical_prices|safe }};
        const labels = prices.map(p => new Date(p.time * 1000).toLocaleDateString());
        const data = prices.map(p => p.close);
        const fibonacciLevels = {{ fibonacci_levels|safe }};
        const closestLevel = "{{ closest_level }}";
        const currentPrice = {{ current_price|safe }};

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ pair }} Fiyat Grafiği',
                    data: data,
                    borderColor: '#1e90ff',
                    fill: false,
                }]
            },
            options: {
                scales: {
                    x: { 
                        display: true, 
                        title: { display: true, text: 'Tarih' },
                        padding: { right: 60 }
                    },
                    y: { 
                        display: true, 
                        title: { display: true, text: 'Fiyat' },
                        suggestedMin: fibonacciLevels['0%'].value * 0.95,
                        suggestedMax: fibonacciLevels['100%'].value * 1.05
                    }
                },
                plugins: {
                    annotation: {
                        annotations: [
                            ...Object.entries(fibonacciLevels).map(([level, data], index) => ({
                                type: 'line',
                                yMin: data.value,
                                yMax: data.value,
                                borderColor: level === closestLevel ? '#ff0000' : '#ffaa00',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                label: {
                                    display: true,
                                    content: `${level}: ${data.value} (R: ${data.turn_probability}%, U: ${data.rise_probability}%, D: ${data.fall_probability}%)`,
                                    position: 'right',
                                    yAdjust: -10 * (index - 2.5),
                                    backgroundColor: level === closestLevel ? 'rgba(255, 0, 0, 0.7)' : 'rgba(255, 170, 0, 0.7)',
                                    color: '#ffffff',
                                    font: { size: 10 },
                                    padding: 4
                                }
                            })),
                            {
                                type: 'line',
                                yMin: currentPrice,
                                yMax: currentPrice,
                                borderColor: '#00ff00',
                                borderWidth: 2,
                                borderDash: [],
                                label: {
                                    display: true,
                                    content: `Current: ${currentPrice}`,
                                    position: 'end',
                                    xAdjust: -75,
                                    yAdjust: 10,
                                    backgroundColor: 'rgba(0, 255, 0, 0.7)',
                                    color: '#ffffff',
                                    font: { size: 12 },
                                    padding: 4
                                }
                            }
                        ]
                    }
                }
            }
        });

        function updateTimeframe() {
            const timeframe = document.getElementById('timeframe').value;
            window.location.href = `/pair/{{ pair }}/?timeframe=${timeframe}`;
        }
    </script>
</body>
</html>