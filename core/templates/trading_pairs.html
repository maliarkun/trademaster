<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Trading Pairs</title>
    <!-- Sayfa stilini tanımlayan CSS -->
    <style>
        body {
            background-color: #1a1a1a; /* Koyu arka plan rengi */
            color: #e0e0e0; /* Açık metin rengi */
            font-family: 'Roboto', sans-serif; /* Modern bir font */
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #ffffff; /* Başlık rengi */
        }
        table {
            width: 80%; /* Tablo genişliği */
            margin: 20px auto; /* Ortalanmış tablo */
            border-collapse: collapse; /* Kenar boşluklarını kaldır */
            background-color: #2c2c2c; /* Tablo arka plan rengi */
            border-radius: 8px; /* Köşeleri yuvarlat */
            overflow: hidden; /* Taşmaları gizle */
        }
        th, td {
            padding: 10px; /* Hücre iç boşluğu */
            text-align: center; /* Metni ortala */
            border-bottom: 1px solid #3c3c3c; /* Alt kenar çizgisi */
            position: relative; /* Tooltip için pozisyon */
        }
        th {
            background-color: #3c3c3c; /* Başlık arka plan rengi */
            color: #ffffff; /* Başlık metin rengi */
        }
        tr:hover {
            background-color: #333; /* Satır üzerine gelindiğinde renk değişimi */
        }
        a {
            color: #1e90ff; /* Bağlantı rengi */
            text-decoration: none; /* Alt çizgi kaldırma */
        }
        a:hover {
            text-decoration: underline; /* Üzerine gelindiğinde alt çizgi */
        }
        .uptrend-high { background-color: #28a745; color: #fff; } /* Yüksek yükselme ihtimali */
        .uptrend-low { background-color: #dc3545; color: #fff; } /* Düşük yükselme ihtimali */
        .downtrend-high { background-color: #dc3545; color: #fff; } /* Yüksek düşme ihtimali */
        .downtrend-low { background-color: #28a745; color: #fff; } /* Düşük düşme ihtimali */
        .signal-cell .golden-cross { color: #28a745; font-size: 16px; } /* Golden Cross sinyali */
        .signal-cell .death-cross { color: #dc3545; font-size: 16px; } /* Death Cross sinyali */
        .adx-signal-cell .strong-up { color: #28a745; font-size: 16px; } /* Güçlü yükseliş */
        .adx-signal-cell .strong-down { color: #dc3545; font-size: 16px; } /* Güçlü düşüş */
        .adx-signal-cell .weak { color: #6c757d; font-size: 16px; } /* Zayıf trend */
        .stoch-signal-cell .stoch-buy-arrow { color: #28a745; font-size: 16px; } /* Stochastic alım */
        .stoch-signal-cell .stoch-sell-arrow { color: #dc3545; font-size: 16px; } /* Stochastic satış */
        .stoch-signal-cell .stoch-neutral { color: #6c757d; font-size: 16px; } /* Stochastic nötr */
        .rsi-signal-cell .rsi-buy-arrow { color: #28a745; font-size: 16px; } /* RSI alım */
        .rsi-signal-cell .rsi-sell-arrow { color: #dc3545; font-size: 16px; } /* RSI satış */
        .rsi-signal-cell .rsi-neutral { color: #6c757d; font-size: 16px; } /* RSI nötr */
        .ichimoku-signal-cell .ichimoku-up { color: #28a745; font-size: 16px; } /* Ichimoku yükseliş */
        .ichimoku-signal-cell .ichimoku-down { color: #dc3545; font-size: 16px; } /* Ichimoku düşüş */
        .atr-signal-cell .atr-high { color: #dc3545; font-size: 16px; } /* Yüksek volatilite */
        .vwap-signal-cell .vwap-up { color: #28a745; font-size: 16px; } /* VWAP yükseliş */
        .vwap-signal-cell .vwap-down { color: #dc3545; font-size: 16px; } /* VWAP düşüş */
        .tooltip {
            position: absolute; /* Tooltip'in konumu */
            background-color: #1e90ff; /* Arka plan rengi */
            color: #fff; /* Metin rengi */
            padding: 10px; /* İç boşluk */
            border-radius: 4px; /* Yuvarlak köşeler */
            font-size: 14px; /* Yazı boyutu */
            max-width: 300px; /* Maksimum genişlik */
            white-space: normal; /* Metnin alt satıra geçmesini sağlar */
            line-height: 1.5; /* Satır aralığı */
            z-index: 1000; /* Üstte görünmesini sağlar */
            pointer-events: none; /* Tıklanamaz yapar */
            display: none; /* Varsayılan olarak gizli */
        }
    </style>
    <!-- Roboto fontunu Google Fonts'tan ekle -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <h1>Trading Pairs</h1> <!-- Sayfa başlığı -->
    <table id="priceTable">
        <thead>
            <tr>
                <!-- Tablo başlıkları ve tooltip açıklamaları -->
                <th data-tooltip="Bu sütun, işlem yapılan kripto para çiftini gösterir (örneğin, BTC/USDT).">Pairs</th>
                <th data-tooltip="Şu anki fiyatı gösterir, piyasadaki son işlem fiyatıdır.">Price</th>
                <th data-tooltip="50 SMA ile 200 SMA'nın kesişimi. Alım veya satış sinyali verebilir.">SMA Signal</th>
                <th data-tooltip="Stochastic’e göre alım veya satış sinyali. %K ve %D’nin kesişimine bakar.">Stoch Signal</th>
                <th data-tooltip="Trendin gücünü ölçer. Yüksekse güçlü bir trend var demektir.">ADX</th>
                <th data-tooltip="ADX’in trend gücüne göre sinyali. Güçlü veya zayıf trendi gösterir.">ADX Signal</th>
                <th data-tooltip="Fiyatın momentumunu ölçer. 70 üzeri aşırı alım, 30 altı aşırı satım demektir.">RSI</th>
                <th data-tooltip="RSI’ya göre durum. Aşırı alım veya satım sinyali verebilir.">RSI Signal</th>
                <th data-tooltip="Ichimoku sinyali: trend yönü ve alım/satım fırsatları.">Ichimoku Signal</th>
                <th data-tooltip="ATR (Average True Range): Piyasanın volatilitesini ölçer.">ATR</th>
                <th data-tooltip="ATR sinyali: Volatilite durumu.">ATR Signal</th>
                <th data-tooltip="VWAP (Volume Weighted Average Price): Hacme dayalı ortalama fiyat.">VWAP</th>
                <th data-tooltip="VWAP sinyali: Fiyatın ortalamaya göre durumu.">VWAP Signal</th>
                <th data-tooltip="Fiyata en yakın Fibonacci seviyesi. Destek veya direnç noktalarını gösterir.">Near Fibo</th>
                <th data-tooltip="Fiyatın bu seviyede yön değiştirme olasılığı. % olarak hesaplanır.">Reversal %</th>
                <th data-tooltip="Fiyatın bu seviyeden düşme olasılığı. %50 üzeri kırmızı, altı yeşildir.">Downtrend %</th>
                <th data-tooltip="Fiyatın bu seviyeden yükselme ihtimali. %50 üzeri yeşil, altı kırmızıdır.">Uptrend %</th>
            </tr>
        </thead>
        <tbody id="priceTableBody">
            <!-- Django döngüsü ile her işlem çifti için veri ekle -->
            {% for pair, data in price_data.items %}
            <tr data-pair="{{ pair }}">
                <td data-tooltip="Bu çifte tıklayarak detaylı analiz sayfasına gidebilirsiniz."><a href="/pair/{{ pair }}/">{{ pair }}</a></td>
                <td data-tooltip="Bu, şu an piyasada bu çiftin son işlem gördüğü fiyatıdır." class="current-price">{{ data.current_price }}</td>
                <td data-tooltip="50 SMA 200 SMA’yı geçtiğinde alım, tersi olduğunda satış sinyali olabilir." class="signal-cell">{{ data.signal }}</td>
                <td data-tooltip="%K %D’yi geçtiğinde alım, tersinde satış sinyali verebilir." class="stoch-signal-cell">{{ data.stoch_signal }}</td>
                <td data-tooltip="25 üzeri güçlü bir trend, 20 altı zayıf bir piyasa demektir.">{{ data.adx }}</td>
                <td data-tooltip="Trendin yönünü ve gücünü gösterir (yukarı ok: yükseliş, aşağı ok: düşüş)." class="adx-signal-cell">{{ data.adx_signal }}</td>
                <td data-tooltip="Fiyatın hızını ölçer, 70 üstü pahalı, 30 altı ucuz anlamına gelebilir.">{{ data.rsi }}</td>
                <td data-tooltip="RSI’nın durumu: Aşırı alım pahalı, aşırı satım ucuz demektir." class="rsi-signal-cell">{{ data.rsi_signal }}</td>
                <td data-tooltip="Ichimoku sinyali, trend yönünü ve olası alım/satım fırsatlarını gösterir." class="ichimoku-signal-cell">{{ data.ichimoku_signal }}</td>
                <td data-tooltip="ATR, piyasanın volatilitesini ölçer.">{{ data.atr }}</td>
                <td data-tooltip="ATR sinyali, volatilitenin durumunu belirtir." class="atr-signal-cell">{{ data.atr_signal }}</td>
                <td data-tooltip="VWAP, hacme dayalı ortalama fiyatı gösterir.">{{ data.vwap }}</td>
                <td data-tooltip="VWAP sinyali, fiyatın ortalamaya göre durumunu gösterir." class="vwap-signal-cell">{{ data.vwap_signal }}</td>
                <td data-tooltip="Fiyatın en yakın Fibonacci seviyesi, destek veya dirençtir.">{{ data.closest_fibonacci_level }}</td>
                <td data-tooltip="Fiyatın tersine dönme ihtimali.">{{ data.turn_probability }}</td>
                <td data-tooltip="Fiyatın düşme ihtimali." class="downtrend-cell" data-fall="{{ data.fall_probability }}">{{ data.fall_probability }}</td>
                <td data-tooltip="Fiyatın yükselme ihtimali." class="uptrend-cell" data-rise="{{ data.rise_probability }}">{{ data.rise_probability }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- JavaScript ile dinamik güncellemeler -->
    <script>
        // Daha önce gönderilen bildirimleri localStorage’dan al
        let sentNotifications = JSON.parse(localStorage.getItem('sentNotifications')) || [];

        // Fiyatları güncelleyen fonksiyon
        function updatePrices() {
            fetch('/prices/json/')  // Fiyatları JSON formatında çeken endpoint
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('priceTableBody');
                    const pairsToNotify = []; // Bildirim gönderilecek çiftler

                    tbody.querySelectorAll('tr').forEach(row => {
                        const pair = row.getAttribute('data-pair');
                        const newPrice = data[pair];
                        if (newPrice) {
                            const priceCell = row.querySelector('.current-price');
                            const oldPrice = parseFloat(priceCell.textContent);
                            priceCell.textContent = newPrice;
                            // Fiyat değişimine göre renk animasyonu
                            if (oldPrice < newPrice) {
                                priceCell.style.color = '#00ff00'; // Yeşil: Yükseliş
                            } else if (oldPrice > newPrice) {
                                priceCell.style.color = '#ff0000'; // Kırmızı: Düşüş
                            }
                            setTimeout(() => priceCell.style.color = '#e0e0e0', 1000); // 1 sn sonra normale dön
                        }

                        // Yükselme ihtimalini kontrol et ve bildirim gönder
                        const riseCell = row.querySelector('.uptrend-cell');
                        const riseProbability = parseInt(riseCell.getAttribute('data-rise'));
                        if (riseProbability >= 51 && !sentNotifications.includes(pair)) {
                            pairsToNotify.push(pair);
                            sentNotifications.push(pair); // Bildirilen çifti kaydet
                        }
                    });

                    // Bildirimleri gönder
                    if (pairsToNotify.length > 0) {
                        fetch('/send_notifications/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}' // Django CSRF token
                            },
                            body: JSON.stringify({chat_id: '1001423950701', pairs: pairsToNotify})
                        })
                        .then(response => {
                            console.log('Bildirim gönderildi:', pairsToNotify);
                            localStorage.setItem('sentNotifications', JSON.stringify(sentNotifications));
                        })
                        .catch(error => console.error('Bildirim gönderilemedi:', error));
                    }

                    updateUptrendColors(); // Yükselme ihtimali renklerini güncelle
                    updateDowntrendColors(); // Düşme ihtimali renklerini güncelle
                })
                .catch(error => console.error('Fiyatlar güncellenirken hata oluştu:', error));
        }

        // Diğer verileri güncelleyen fonksiyon (5 dakikada bir çalışacak)
        function updateIndicators() {
            fetch('/indicators/json/')  // Göstergeleri JSON formatında çeken endpoint
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('priceTableBody');
                    tbody.querySelectorAll('tr').forEach(row => {
                        const pair = row.getAttribute('data-pair');
                        const indicators = data[pair];
                        if (indicators) {
                            // SMA Signal güncelle
                            const smaSignalCell = row.querySelector('.signal-cell');
                            smaSignalCell.textContent = indicators.sma_signal;
                            // Stoch Signal güncelle
                            const stochSignalCell = row.querySelector('.stoch-signal-cell');
                            stochSignalCell.textContent = indicators.stoch_signal;
                            // ADX güncelle
                            const adxCell = row.querySelector('td:nth-child(5)'); // ADX sütunu
                            adxCell.textContent = indicators.adx;
                            // ADX Signal güncelle
                            const adxSignalCell = row.querySelector('.adx-signal-cell');
                            adxSignalCell.textContent = indicators.adx_signal;
                            // RSI güncelle
                            const rsiCell = row.querySelector('td:nth-child(7)'); // RSI sütunu
                            rsiCell.textContent = indicators.rsi;
                            // RSI Signal güncelle
                            const rsiSignalCell = row.querySelector('.rsi-signal-cell');
                            rsiSignalCell.textContent = indicators.rsi_signal;
                            // Ichimoku Signal güncelle
                            const ichimokuSignalCell = row.querySelector('.ichimoku-signal-cell');
                            ichimokuSignalCell.textContent = indicators.ichimoku_signal;
                            // ATR güncelle
                            const atrCell = row.querySelector('td:nth-child(10)'); // ATR sütunu
                            atrCell.textContent = indicators.atr;
                            // ATR Signal güncelle
                            const atrSignalCell = row.querySelector('.atr-signal-cell');
                            atrSignalCell.textContent = indicators.atr_signal;
                            // VWAP güncelle
                            const vwapCell = row.querySelector('td:nth-child(12)'); // VWAP sütunu
                            vwapCell.textContent = indicators.vwap;
                            // VWAP Signal güncelle
                            const vwapSignalCell = row.querySelector('.vwap-signal-cell');
                            vwapSignalCell.textContent = indicators.vwap_signal;
                            // Near Fibo güncelle
                            const nearFiboCell = row.querySelector('td:nth-child(14)'); // Near Fibo sütunu
                            nearFiboCell.textContent = indicators.near_fibo;
                            // Reversal % güncelle
                            const reversalCell = row.querySelector('td:nth-child(15)'); // Reversal % sütunu
                            reversalCell.textContent = indicators.reversal;
                            // Downtrend % güncelle
                            const downtrendCell = row.querySelector('.downtrend-cell');
                            downtrendCell.textContent = indicators.downtrend;
                            downtrendCell.setAttribute('data-fall', indicators.downtrend);
                            // Uptrend % güncelle
                            const uptrendCell = row.querySelector('.uptrend-cell');
                            uptrendCell.textContent = indicators.uptrend;
                            uptrendCell.setAttribute('data-rise', indicators.uptrend);
                        }
                    });

                    // Güncellenen verilere göre sinyal oklarını ve renkleri yenile
                    updateStochSignals();
                    updateRsiSignals();
                    updateSignalArrows();
                    updateAdxSignals();
                    updateIchimokuSignals();
                    updateAtrSignals();
                    updateVwapSignals();
                    updateUptrendColors();
                    updateDowntrendColors();
                })
                .catch(error => console.error('Gösterge verileri güncellenirken hata oluştu:', error));
        }

        // Yükselme ihtimali hücrelerinin renklerini güncelle
        function updateUptrendColors() {
            document.querySelectorAll('.uptrend-cell').forEach(cell => {
                const riseProbability = parseInt(cell.getAttribute('data-rise'));
                if (riseProbability > 50) {
                    cell.classList.add('uptrend-high');
                    cell.classList.remove('uptrend-low');
                } else {
                    cell.classList.add('uptrend-low');
                    cell.classList.remove('uptrend-high');
                }
            });
        }

        // Düşme ihtimali hücrelerinin renklerini güncelle
        function updateDowntrendColors() {
            document.querySelectorAll('.downtrend-cell').forEach(cell => {
                const fallProbability = parseInt(cell.getAttribute('data-fall'));
                if (fallProbability > 50) {
                    cell.classList.add('downtrend-high');
                    cell.classList.remove('downtrend-low');
                } else {
                    cell.classList.add('downtrend-low');
                    cell.classList.remove('downtrend-high');
                }
            });
        }

        // Stochastic sinyallerini güncelle (oklarla göster)
        function updateStochSignals() {
            document.querySelectorAll('.stoch-signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Alım') {
                    cell.innerHTML = '<span class="stoch-buy-arrow">↑</span>';
                } else if (signal === 'Satış') {
                    cell.innerHTML = '<span class="stoch-sell-arrow">↓</span>';
                } else if (signal === 'Nötr') {
                    cell.innerHTML = '<span class="stoch-neutral">—</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // RSI sinyallerini güncelle (oklarla göster)
        function updateRsiSignals() {
            document.querySelectorAll('.rsi-signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Aşırı Satım (Alım)') {
                    cell.innerHTML = '<span class="rsi-buy-arrow">↑</span>';
                } else if (signal === 'Aşırı Alım (Satış)') {
                    cell.innerHTML = '<span class="rsi-sell-arrow">↓</span>';
                } else if (signal === 'Nötr') {
                    cell.innerHTML = '<span class="rsi-neutral">—</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // SMA sinyallerini güncelle (oklarla göster)
        function updateSignalArrows() {
            document.querySelectorAll('.signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Golden Cross (Alım)') {
                    cell.innerHTML = '<span class="golden-cross">↑</span>';
                } else if (signal === 'Death Cross (Satış)') {
                    cell.innerHTML = '<span class="death-cross">↓</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // ADX sinyallerini güncelle (oklarla göster)
        function updateAdxSignals() {
            document.querySelectorAll('.adx-signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Güçlü Yükseliş') {
                    cell.innerHTML = '<span class="strong-up">↑</span>';
                } else if (signal === 'Güçlü Düşüş') {
                    cell.innerHTML = '<span class="strong-down">↓</span>';
                } else if (signal === 'Zayıf Trend') {
                    cell.innerHTML = '<span class="weak">—</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // Ichimoku sinyallerini güncelle (oklarla göster)
        function updateIchimokuSignals() {
            document.querySelectorAll('.ichimoku-signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Yükseliş Trendi') {
                    cell.innerHTML = '<span class="ichimoku-up">↑</span>';
                } else if (signal === 'Düşüş Trendi') {
                    cell.innerHTML = '<span class="ichimoku-down">↓</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // ATR sinyallerini güncelle (oklarla göster)
        function updateAtrSignals() {
            document.querySelectorAll('.atr-signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Yüksek Volatilite') {
                    cell.innerHTML = '<span class="atr-high">↓</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // VWAP sinyallerini güncelle (oklarla göster)
        function updateVwapSignals() {
            document.querySelectorAll('.vwap-signal-cell').forEach(cell => {
                const signal = cell.textContent.trim();
                cell.innerHTML = '';
                if (signal === 'Fiyat Ortalamanın Üzerinde') {
                    cell.innerHTML = '<span class="vwap-up">↑</span>';
                } else if (signal === 'Fiyat Ortalamanın Altında') {
                    cell.innerHTML = '<span class="vwap-down">↓</span>';
                } else {
                    cell.innerHTML = signal;
                }
            });
        }

        // Tooltip işlemleri: Fare üzerine gelindiğinde açıklama göster
        document.querySelectorAll('[data-tooltip]').forEach(element => {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = element.getAttribute('data-tooltip');
            document.body.appendChild(tooltip);

            element.addEventListener('mouseover', (e) => {
                const rect = element.getBoundingClientRect();
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.display = 'block';
            });

            element.addEventListener('mouseout', () => {
                tooltip.style.display = 'none';
            });
        });

        // Her 10 saniyede bir fiyatları güncelle
        setInterval(updatePrices, 10000);

        // Her 5 dakikada bir (300000 ms) diğer verileri güncelle
        setInterval(updateIndicators, 300000);

        // Sayfa yüklendiğinde ilk güncellemeleri yap
        updatePrices();
        updateIndicators(); // Göstergeleri de ilk yüklemede güncelle
        updateUptrendColors();
        updateDowntrendColors();
        updateStochSignals();
        updateRsiSignals();
        updateSignalArrows();
        updateAdxSignals();
        updateIchimokuSignals();
        updateAtrSignals();
        updateVwapSignals();
    </script>
</body>
</html>